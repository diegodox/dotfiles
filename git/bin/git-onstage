#!/bin/sh

if [ -z "$1" ]; then
    echo "no command is passed"
	exit 1
fi

STASH_TIME=$(date +%s)

# Stash all changes
STASH=pre-commit-$STASH_TIME
git stash push --include-untracked --quiet --message "$STASH"

# Move to temporary branch
PRECOMMIT_BRANCH="pre-commit-$STASH_TIME"
git checkout --quiet -b "$PRECOMMIT_BRANCH"

# Apply changes
STASH_NUM=$(git stash list | grep "$STASH" | sed -re 's/stash@\{(.*)\}.*/\1/')
if [ -n "$STASH_NUM" ]; then
	git stash apply --index --quiet "$STASH_NUM"
else
	echo "Stash not found, you may try to commit with no index..."
fi

# Delete unstaged changes
git clean --quiet --force -d
git restore .

# Do for staged changes
"$@"
EXIT_VALUE=$?

# Move to previous branch
git reset --hard --quiet
git checkout --quiet -

# Delete temporary branch
git branch --quiet --delete "$PRECOMMIT_BRANCH"

# Restore changes
if [ -n "$STASH_NUM" ]; then
	git stash pop --index --quiet "$STASH_NUM"
fi

# Return result
exit $EXIT_VALUE

